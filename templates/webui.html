<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>OnnxOCR Web UI</title>
    <link rel="stylesheet" href="/static/webui.css">
</head>
<body>
<div class="container">
    <h2>OnnxOCR Web UI</h2>
    
    <!-- æ¥å£åˆ‡æ¢æ ‡ç­¾é¡µ -->
    <div class="api-tabs">
        <button class="tab-button active" data-api="v2">V2 å¢å¼ºæ¨¡å¼</button>
        <button class="tab-button" data-api="v1">V1 å…¼å®¹æ¨¡å¼</button>
    </div>
    
    <!-- é…ç½®é¢æ¿ -->
    <div class="config-panel">
        <!-- V2 æ¥å£é…ç½® -->
        <div id="v2-config" class="config-section active">
            <div class="config-group">
                <label for="v2-model">æ¨¡å‹é€‰æ‹©</label>
                <select id="v2-model" name="model_name">
                    <option value="PP-OCRv5">PP-OCRv5 (æ¨è)</option>
                    <option value="PP-OCRv4">PP-OCRv4</option>
                    <option value="ch_ppocr_server_v2.0">ch_ppocr_server_v2.0</option>
                </select>
            </div>
            <div class="config-group">
                <label for="v2-threshold">ç½®ä¿¡åº¦é˜ˆå€¼</label>
                <input type="range" id="v2-threshold" min="0" max="1" step="0.1" value="0.5">
                <span id="threshold-value">0.5</span>
            </div>
            <div class="config-group">
                <label for="v2-format">è¾“å‡ºæ ¼å¼</label>
                <select id="v2-format">
                    <option value="json">JSON (ç»“æ„åŒ–)</option>
                    <option value="text">çº¯æ–‡æœ¬</option>
                    <option value="tsv">TSV (è¡¨æ ¼)</option>
                    <option value="hocr">hOCR (HTML)</option>
                </select>
            </div>
            <div class="config-group">
                <label class="checkbox-group">
                    <input type="checkbox" id="v2-bbox" checked>
                    <span>æ˜¾ç¤ºè¾¹ç•Œæ¡†åæ ‡</span>
                </label>
            </div>
            <div class="config-group">
                <label class="checkbox-group">
                    <input type="checkbox" id="v2-return-image">
                    <span>è¿”å›æ ‡æ³¨å›¾åƒ</span>
                </label>
            </div>
        </div>
        
        <!-- V1 æ¥å£é…ç½® -->
        <div id="v1-config" class="config-section">
            <div class="config-group">
                <label>æ¥å£ç±»å‹</label>
                <span class="config-info">Base64 JSON (å…¼å®¹åŸFlaskæ¥å£)</span>
            </div>
            <div class="config-group">
                <label>è¾“å‡ºæ ¼å¼</label>
                <span class="config-info">å›ºå®šJSONæ ¼å¼ï¼ŒåŒ…å«textã€confidenceã€bounding_box</span>
            </div>
        </div>
    </div>
    
    <!-- æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
    <form id="ocrForm">
        <div class="upload-section">
            <div id="dropZone" class="drop-zone">
                <div class="drop-content">
                    <div class="upload-icon">ğŸ“</div>
                    <div class="upload-text">
                        <div>ç‚¹å‡»é€‰æ‹©æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„</div>
                        <div class="upload-hint">æ”¯æŒ JPGã€PNGã€BMP å›¾ç‰‡æ ¼å¼</div>
                    </div>
                </div>
            </div>
            <input id="fileInput" type="file" name="files" multiple accept="image/*" />
        </div>
        
        <div class="file-list-section">
            <ul id="fileList"></ul>
        </div>
        
        <div class="action-section">
            <button type="submit" id="recognizeBtn">å¼€å§‹è¯†åˆ«</button>
            <button type="button" id="clearBtn">æ¸…é™¤å…¨éƒ¨</button>
        </div>
    </form>
    
    <!-- è¿›åº¦æ˜¾ç¤º -->
    <div id="progressArea">
        <div id="progressText">å‡†å¤‡è¯†åˆ«...</div>
        <div class="progress-bar-bg">
            <div class="progress-bar" id="progressBar"></div>
        </div>
        <div id="elapsedTime"></div>
    </div>
    
    <!-- ç»“æœå±•ç¤ºåŒºåŸŸ -->
    <div id="resultArea">
        <!-- åŠ¨æ€ç”Ÿæˆç»“æœå†…å®¹ -->
    </div>
</div>

<!-- å…¨å±€æç¤ºç»„ä»¶ -->
<div id="globalTip"></div>

<script>
// å…¨å±€å˜é‡
const apiTabs = document.querySelectorAll('.tab-button');
const configSections = document.querySelectorAll('.config-section');
const dropZone = document.getElementById('dropZone');
const fileInput = document.getElementById('fileInput');
const ocrForm = document.getElementById('ocrForm');
const resultArea = document.getElementById('resultArea');
const clearBtn = document.getElementById('clearBtn');
const progressArea = document.getElementById('progressArea');
const progressBar = document.getElementById('progressBar');
const progressText = document.getElementById('progressText');
const elapsedTime = document.getElementById('elapsedTime');
const fileList = document.getElementById('fileList');
const thresholdSlider = document.getElementById('v2-threshold');
const thresholdValue = document.getElementById('threshold-value');

let currentAPI = 'v2';
let uploadedFiles = [];

// åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    initializeEventListeners();
    updateFileList();
});

// äº‹ä»¶ç›‘å¬å™¨åˆå§‹åŒ–
function initializeEventListeners() {
    // API åˆ‡æ¢æ ‡ç­¾
    apiTabs.forEach(tab => {
        tab.addEventListener('click', handleAPISwitch);
    });
    
    // ç½®ä¿¡åº¦æ»‘å—
    thresholdSlider.addEventListener('input', function() {
        thresholdValue.textContent = this.value;
    });
    
    // æ–‡ä»¶ä¸Šä¼ 
    setupFileUpload();
    
    // è¡¨å•æäº¤
    ocrForm.addEventListener('submit', handleFormSubmit);
    
    // æ¸…é™¤æŒ‰é’®
    clearBtn.addEventListener('click', clearAll);
}

// APIåˆ‡æ¢å¤„ç†
function handleAPISwitch(e) {
    const selectedAPI = e.target.dataset.api;
    
    // æ›´æ–°æ ‡ç­¾çŠ¶æ€
    apiTabs.forEach(tab => {
        tab.classList.toggle('active', tab.dataset.api === selectedAPI);
    });
    
    // æ›´æ–°é…ç½®é¢æ¿
    configSections.forEach(section => {
        section.classList.toggle('active', section.id === selectedAPI + '-config');
    });
    
    currentAPI = selectedAPI;
    
    // æ›´æ–°æ–‡ä»¶è¾“å…¥çš„multipleå±æ€§
    if (selectedAPI === 'v1') {
        fileInput.removeAttribute('multiple');
        // V1æ¨¡å¼åªæ”¯æŒå•æ–‡ä»¶ï¼Œå¦‚æœæœ‰å¤šä¸ªæ–‡ä»¶åˆ™åªä¿ç•™ç¬¬ä¸€ä¸ª
        if (uploadedFiles.length > 1) {
            uploadedFiles = uploadedFiles.slice(0, 1);
            updateFileList();
        }
    } else {
        fileInput.setAttribute('multiple', 'multiple');
    }
    
    showTip(`å·²åˆ‡æ¢åˆ° ${selectedAPI.toUpperCase()} æ¥å£æ¨¡å¼`);
}

// æ–‡ä»¶ä¸Šä¼ è®¾ç½®
function setupFileUpload() {
    // æ‹–æ‹½äº‹ä»¶
    ['dragenter', 'dragover'].forEach(evt => {
        dropZone.addEventListener(evt, e => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });
    });
    
    ['dragleave', 'drop'].forEach(evt => {
        dropZone.addEventListener(evt, e => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
        });
    });
    
    dropZone.addEventListener('click', () => fileInput.click());
    
    dropZone.addEventListener('drop', e => {
        const files = Array.from(e.dataTransfer.files);
        handleFileSelection(files);
    });
    
    fileInput.addEventListener('change', e => {
        const files = Array.from(e.target.files);
        handleFileSelection(files);
    });
}

// æ–‡ä»¶é€‰æ‹©å¤„ç†
function handleFileSelection(files) {
    if (currentAPI === 'v1' && files.length > 1) {
        showTip('V1æ¥å£åªæ”¯æŒå•æ–‡ä»¶ä¸Šä¼ ', '#f87171');
        files = files.slice(0, 1);
    }
    
    // è¿‡æ»¤æ”¯æŒçš„æ–‡ä»¶ç±»å‹
    const supportedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/bmp'];
    const validFiles = files.filter(file => {
        if (supportedTypes.includes(file.type) || 
            file.name.toLowerCase().match(/\.(jpg|jpeg|png|bmp)$/)) {
            return true;
        }
        showTip(`ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼: ${file.name}`, '#f87171');
        return false;
    });
    
    if (validFiles.length > 0) {
        uploadedFiles = validFiles;
        updateFileList();
        showTip(`å·²é€‰æ‹© ${validFiles.length} ä¸ªæ–‡ä»¶`);
    }
}

// æ›´æ–°æ–‡ä»¶åˆ—è¡¨æ˜¾ç¤º
function updateFileList() {
    fileList.innerHTML = '';
    
    if (uploadedFiles.length === 0) {
        fileList.innerHTML = '<li class="no-files">æœªé€‰æ‹©æ–‡ä»¶</li>';
        return;
    }
    
    uploadedFiles.forEach((file, index) => {
        const li = document.createElement('li');
        li.className = 'file-item';
        li.innerHTML = `
            <span class="file-name">${file.name}</span>
            <span class="file-size">(${formatFileSize(file.size)})</span>
            <button type="button" class="remove-file" onclick="removeFile(${index})">Ã—</button>
        `;
        fileList.appendChild(li);
    });
}

// ç§»é™¤æ–‡ä»¶
function removeFile(index) {
    uploadedFiles.splice(index, 1);
    updateFileList();
    showTip('æ–‡ä»¶å·²ç§»é™¤');
}

// æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
function formatFileSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
}

// è¡¨å•æäº¤å¤„ç†
async function handleFormSubmit(e) {
    e.preventDefault();
    
    if (uploadedFiles.length === 0) {
        showTip('è¯·å…ˆé€‰æ‹©è¦è¯†åˆ«çš„æ–‡ä»¶', '#f87171');
        return;
    }
    
    // æ˜¾ç¤ºè¿›åº¦
    showProgress(true);
    const startTime = Date.now();
    
    try {
        let result;
        if (currentAPI === 'v1') {
            result = await processWithV1API();
        } else {
            result = await processWithV2API();
        }
        
        // æ˜¾ç¤ºç»“æœ
        displayResults(result);
        
        const processingTime = ((Date.now() - startTime) / 1000).toFixed(2);
        elapsedTime.textContent = `æ€»è€—æ—¶: ${processingTime} ç§’`;
        
    } catch (error) {
        console.error('OCRå¤„ç†å¤±è´¥:', error);
        let errorMessage = 'è¯†åˆ«å¤±è´¥';
        if (error.message.includes('Failed to fetch')) {
            errorMessage = 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€';
        } else if (error.message.includes('HTTP 413')) {
            errorMessage = 'æ–‡ä»¶è¿‡å¤§ï¼Œè¯·é€‰æ‹©è¾ƒå°çš„æ–‡ä»¶';
        } else if (error.message.includes('HTTP 415')) {
            errorMessage = 'ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹';
        } else if (error.message.includes('HTTP 500')) {
            errorMessage = 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•';
        } else {
            errorMessage += ': ' + error.message;
        }
        showTip(errorMessage, '#f87171');
        resultArea.innerHTML = `<div class="error-message">${errorMessage}</div>`;
    } finally {
        showProgress(false);
    }
}

// V1 API å¤„ç†
async function processWithV1API() {
    const file = uploadedFiles[0];
    const base64Data = await fileToBase64(file);
    
    progressText.textContent = 'ä½¿ç”¨V1æ¥å£è¯†åˆ«ä¸­...';
    progressBar.style.width = '50%';
    
    const response = await fetch('/ocr', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            image: base64Data.split(',')[1] // ç§»é™¤data:image/jpeg;base64,å‰ç¼€
        })
    });
    
    progressBar.style.width = '100%';
    
    if (!response.ok) {
        throw new Error(`HTTP ${response.status}`);
    }
    
    const result = await response.json();
    if (result.error) {
        throw new Error(result.error);
    }
    
    return {
        api: 'v1',
        single: true,
        data: result,
        file: file
    };
}

// V2 API å¤„ç†
async function processWithV2API() {
    const formData = new FormData();
    
    // æ·»åŠ æ–‡ä»¶
    uploadedFiles.forEach(file => {
        formData.append('files', file);
    });
    
    // æ·»åŠ é…ç½®å‚æ•°
    formData.append('model_name', document.getElementById('v2-model').value);
    formData.append('conf_threshold', document.getElementById('v2-threshold').value);
    formData.append('output_format', document.getElementById('v2-format').value);
    formData.append('bbox', document.getElementById('v2-bbox').checked);
    formData.append('return_image', document.getElementById('v2-return-image').checked);
    
    progressText.textContent = 'ä½¿ç”¨V2æ¥å£è¯†åˆ«ä¸­...';
    progressBar.style.width = '50%';
    
    const response = await fetch('/api/v2/ocr', {
        method: 'POST',
        body: formData
    });
    
    progressBar.style.width = '100%';
    
    if (!response.ok) {
        throw new Error(`HTTP ${response.status}`);
    }
    
    const result = await response.json();
    if (result.error) {
        throw new Error(result.error);
    }
    
    return {
        api: 'v2',
        single: uploadedFiles.length === 1,
        data: result,
        files: uploadedFiles
    };
}

// æ˜¾ç¤ºå¤„ç†ç»“æœ
function displayResults(result) {
    resultArea.innerHTML = '';
    
    if (result.api === 'v1' || result.single) {
        // å•æ–‡ä»¶ç»“æœå±•ç¤º
        displaySingleResult(result);
    } else {
        // å¤šæ–‡ä»¶ç»“æœå±•ç¤º
        displayMultipleResults(result);
    }
}

// å•æ–‡ä»¶ç»“æœå±•ç¤º
function displaySingleResult(result) {
    const container = document.createElement('div');
    container.className = 'result-container';
    
    // åˆ›å»ºå¹¶æ’å¸ƒå±€
    const sideBySide = document.createElement('div');
    sideBySide.className = 'side-by-side';
    
    // å·¦ä¾§: åŸå›¾
    const imageSection = document.createElement('div');
    imageSection.className = 'image-section';
    
    const imageTitle = document.createElement('h3');
    imageTitle.textContent = 'åŸå›¾';
    imageSection.appendChild(imageTitle);
    
    const img = document.createElement('img');
    img.className = 'original-image';
    img.src = URL.createObjectURL(result.file || result.files[0]);
    img.alt = 'åŸå›¾';
    imageSection.appendChild(img);
    
    // å³ä¾§: è¯†åˆ«ç»“æœ
    const textSection = document.createElement('div');
    textSection.className = 'text-section';
    
    const textTitle = document.createElement('div');
    textTitle.className = 'result-header';
    textTitle.innerHTML = `
        <h3>è¯†åˆ«ç»“æœ</h3>
        <button class="copy-btn" onclick="copyResultText(this)">å¤åˆ¶æ–‡æœ¬</button>
    `;
    textSection.appendChild(textTitle);
    
    const textContent = document.createElement('div');
    textContent.className = 'text-content';
    
    // æ ¹æ®APIç‰ˆæœ¬å’Œæ ¼å¼æ˜¾ç¤ºç»“æœ
    const resultText = formatResultText(result);
    textContent.innerHTML = `<pre>${resultText}</pre>`;
    textSection.appendChild(textContent);
    
    // å¤„ç†æ—¶é—´æ˜¾ç¤º
    const timeInfo = document.createElement('div');
    timeInfo.className = 'time-info';
    timeInfo.textContent = `å¤„ç†æ—¶é—´: ${result.data.processing_time.toFixed(3)} ç§’`;
    textSection.appendChild(timeInfo);
    
    sideBySide.appendChild(imageSection);
    sideBySide.appendChild(textSection);
    container.appendChild(sideBySide);
    resultArea.appendChild(container);
}

// å¤šæ–‡ä»¶ç»“æœå±•ç¤º
function displayMultipleResults(result) {
    const container = document.createElement('div');
    container.className = 'multiple-results-container';
    
    const header = document.createElement('div');
    header.className = 'results-header';
    header.innerHTML = `
        <h3>æ‰¹é‡è¯†åˆ«ç»“æœ (${result.data.items.length} ä¸ªæ–‡ä»¶)</h3>
        <div class="batch-actions">
            <button class="copy-all-btn" onclick="copyAllResults()">å¤åˆ¶å…¨éƒ¨</button>
        </div>
    `;
    container.appendChild(header);
    
    // ä¸ºæ¯ä¸ªæ–‡ä»¶åˆ›å»ºç»“æœé¡¹
    result.data.items.forEach((item, index) => {
        const file = result.files[index];
        const resultItem = document.createElement('div');
        resultItem.className = 'result-item';
        
        const sideBySide = document.createElement('div');
        sideBySide.className = 'side-by-side';
        
        // å·¦ä¾§: åŸå›¾
        const imageSection = document.createElement('div');
        imageSection.className = 'image-section small';
        
        const img = document.createElement('img');
        img.className = 'original-image';
        img.src = URL.createObjectURL(file);
        img.alt = item.filename || file.name;
        imageSection.appendChild(img);
        
        // å³ä¾§: è¯†åˆ«ç»“æœ
        const textSection = document.createElement('div');
        textSection.className = 'text-section';
        
        const textTitle = document.createElement('div');
        textTitle.className = 'result-header';
        textTitle.innerHTML = `
            <h4>${item.filename || file.name}</h4>
            <button class="copy-btn" onclick="copyResultText(this)">å¤åˆ¶</button>
        `;
        textSection.appendChild(textTitle);
        
        const textContent = document.createElement('div');
        textContent.className = 'text-content';
        textContent.innerHTML = `<pre>${item.text || JSON.stringify(item.results, null, 2)}</pre>`;
        textSection.appendChild(textContent);
        
        sideBySide.appendChild(imageSection);
        sideBySide.appendChild(textSection);
        resultItem.appendChild(sideBySide);
        container.appendChild(resultItem);
    });
    
    // å¤„ç†æ—¶é—´æ˜¾ç¤º
    const timeInfo = document.createElement('div');
    timeInfo.className = 'time-info';
    timeInfo.textContent = `æ€»å¤„ç†æ—¶é—´: ${result.data.processing_time.toFixed(3)} ç§’`;
    container.appendChild(timeInfo);
    
    resultArea.appendChild(container);
}

// æ ¼å¼åŒ–ç»“æœæ–‡æœ¬
function formatResultText(result) {
    if (result.api === 'v1') {
        return result.data.results.map(r => r.text).join('\n');
    } else {
        const format = document.getElementById('v2-format').value;
        const data = result.data;
        
        switch (format) {
            case 'text':
                return data.text || data.results.map(r => r.text).join('\n');
            case 'tsv':
                return data.tsv;
            case 'hocr':
                return data.hocr;
            default: // json
                return JSON.stringify(data.results, null, 2);
        }
    }
}

// æ–‡ä»¶è½¬Base64
function fileToBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
    });
}

// æ˜¾ç¤º/éšè—è¿›åº¦æ¡
function showProgress(show) {
    if (show) {
        progressArea.style.display = 'flex';
        progressBar.style.width = '0%';
        progressText.textContent = 'å‡†å¤‡è¯†åˆ«...';
        elapsedTime.textContent = '';
    } else {
        setTimeout(() => {
            progressArea.style.display = 'none';
        }, 1000);
    }
}

// æ¸…é™¤å…¨éƒ¨
function clearAll() {
    uploadedFiles = [];
    updateFileList();
    resultArea.innerHTML = '';
    showProgress(false);
    showTip('å·²æ¸…é™¤å…¨éƒ¨å†…å®¹');
}

// å¤åˆ¶ç»“æœæ–‡æœ¬
function copyResultText(button) {
    const textContent = button.closest('.text-section').querySelector('pre').textContent;
    navigator.clipboard.writeText(textContent).then(() => {
        showTip('å¤åˆ¶æˆåŠŸ');
        const originalText = button.textContent;
        button.textContent = 'å·²å¤åˆ¶';
        setTimeout(() => {
            button.textContent = originalText;
        }, 2000);
    }).catch(() => {
        showTip('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', '#f87171');
    });
}

// å¤åˆ¶å…¨éƒ¨ç»“æœ
function copyAllResults() {
    const allPres = resultArea.querySelectorAll('pre');
    const allText = Array.from(allPres).map(pre => pre.textContent).join('\n\n---\n\n');
    
    navigator.clipboard.writeText(allText).then(() => {
        showTip('å…¨éƒ¨ç»“æœå·²å¤åˆ¶');
    }).catch(() => {
        showTip('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', '#f87171');
    });
}

// æ˜¾ç¤ºæç¤ºä¿¡æ¯
function showTip(message, color = '#7b8cff') {
    const tip = document.getElementById('globalTip');
    tip.textContent = message;
    tip.style.background = color;
    tip.style.display = 'block';
    tip.style.opacity = '1';
    
    clearTimeout(tip._timer);
    tip._timer = setTimeout(() => {
        tip.style.opacity = '0';
        setTimeout(() => {
            tip.style.display = 'none';
        }, 300);
    }, 2000);
}

</script>
</body>
</html>