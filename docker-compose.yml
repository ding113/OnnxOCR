networks:
  onnxocr-network:
    driver: bridge
    name: onnxocr-network

# ğŸ’¾ æ•°æ®å·é…ç½®
volumes:
  # æŒä¹…åŒ–æ•°æ®å·
  onnxocr-data:
    driver: local
    name: onnxocr-data
  onnxocr-logs:
    driver: local
    name: onnxocr-logs
  onnxocr-cache:
    driver: local
    name: onnxocr-cache

services:
  # ğŸš€ ä¸»è¦OCRæœåŠ¡
  onnxocr-modern:
    build:
      context: .
      dockerfile: Dockerfile
      # æ„å»ºå‚æ•°
      args:
        - PYTHON_VERSION=3.13
        - UV_VERSION=0.8.13
      # æ„å»ºç¼“å­˜é…ç½®
      cache_from:
        - python:3.13-slim
        - ghcr.io/astral-sh/uv:0.8.13
    
    container_name: onnxocr-modern
    hostname: onnxocr-service
    
    # ğŸŒ ç¯å¢ƒå˜é‡é…ç½®
    environment:
      # === æ ¸å¿ƒæœåŠ¡é…ç½® ===
      - HOST=0.0.0.0
      - PORT=5005
      - WORKERS=${WORKERS:-auto}  # æ”¯æŒå¤–éƒ¨é…ç½®
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - ACCESS_LOG=${ACCESS_LOG:-true}
      
      # === ONNX Runtimeä¼˜åŒ– ===
      - ONNX_THREAD_POOL_SIZE=${ONNX_THREADS:-0}  # 0=auto
      - ORT_DISABLE_ALL_OPTIMIZATIONS=0
      - ORT_ENABLE_CPU_FP16_OPS=1
      
      # === OpenMPä¼˜åŒ– ===
      - OMP_NUM_THREADS=${OMP_THREADS:-0}  # 0=auto
      - MKL_NUM_THREADS=${MKL_THREADS:-0}
      - OPENBLAS_NUM_THREADS=${OPENBLAS_THREADS:-0}
      
      # === å†…å­˜å’Œæ€§èƒ½é…ç½® ===
      - MAX_MEMORY_MB=${MAX_MEMORY_MB:-2048}
      - TIMEOUT=${TIMEOUT:-300}
      - KEEP_ALIVE=${KEEP_ALIVE:-5}
      - MAX_REQUESTS=${MAX_REQUESTS:-1000}
      
      # === Pythonä¼˜åŒ– ===
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONIOENCODING=utf-8
      
      # === æ—¶åŒºé…ç½® ===
      - TZ=Asia/Shanghai
    
    # ğŸ”Œ ç«¯å£æ˜ å°„
    ports:
      - "${PORT:-5005}:5005"
    
    # ğŸ”„ é‡å¯ç­–ç•¥
    restart: unless-stopped
    
    # ğŸ“Š èµ„æºé™åˆ¶é…ç½®
    deploy:
      resources:
        limits:
          # CPUé™åˆ¶ (æ ¹æ®ä½ çš„ç¡¬ä»¶è°ƒæ•´)
          cpus: '${CPU_LIMIT:-0}'  # 0è¡¨ç¤ºä½¿ç”¨æ‰€æœ‰CPU
          # å†…å­˜é™åˆ¶
          memory: ${MEMORY_LIMIT:-4G}
        reservations:
          # CPUä¿è¯ (æœ€å°‘ä¿è¯çš„CPUèµ„æº)
          cpus: '${CPU_RESERVATION:-1.0}'
          # å†…å­˜ä¿è¯ (æœ€å°‘ä¿è¯çš„å†…å­˜)
          memory: ${MEMORY_RESERVATION:-1G}
      
      # ğŸ”„ é‡å¯ç­–ç•¥
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
    
    # ğŸ“ æ•°æ®å·æŒ‚è½½
    volumes:
      # === æ•°æ®æŒä¹…åŒ– ===
      - "onnxocr-data:/app/data"                    # åº”ç”¨æ•°æ®
      - "onnxocr-logs:/app/logs"                    # æ—¥å¿—æ–‡ä»¶
      - "onnxocr-cache:/app/.cache"                 # ç¼“å­˜æ•°æ®
      
      # === æœ¬åœ°å¼€å‘æŒ‚è½½ (å¯é€‰ï¼Œç”Ÿäº§ç¯å¢ƒä¸­æ³¨é‡Šæ‰) ===
      # - "./data/uploads:/app/uploads"               # æ–‡ä»¶ä¸Šä¼ 
      # - "./data/results:/app/results"               # å¤„ç†ç»“æœ
      # - "./data/models:/app/onnxocr/models"         # æ¨¡å‹æ–‡ä»¶ (å¦‚éœ€è‡ªå®šä¹‰)
      
      # === é…ç½®æ–‡ä»¶æŒ‚è½½ (å¯é€‰) ===
      # - "./.env:/app/.env:ro"                       # ç¯å¢ƒé…ç½®æ–‡ä»¶
      # - "./custom_config.yaml:/app/config.yaml:ro" # è‡ªå®šä¹‰é…ç½®
    
    # ğŸŒ ç½‘ç»œé…ç½®
    networks:
      - onnxocr-network
    
    # ğŸ©º å¥åº·æ£€æŸ¥é…ç½®
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5005/health"]
      interval: 30s      # æ£€æŸ¥é—´éš”
      timeout: 10s       # æ£€æŸ¥è¶…æ—¶
      retries: 3         # å¤±è´¥é‡è¯•æ¬¡æ•°
      start_period: 60s  # å¯åŠ¨ç­‰å¾…æ—¶é—´ (æ¨¡å‹é¢„çƒ­)
    
    # âš™ï¸ ç³»ç»Ÿé…ç½®
    tmpfs:
      - /tmp:rw,size=1G,mode=1777    # ä¸´æ—¶æ–‡ä»¶ç³»ç»Ÿ (1GB RAM disk)
      - /app/tmp:rw,size=512M        # åº”ç”¨ä¸´æ—¶ç›®å½•
    
    # ğŸ” å®‰å…¨é…ç½®
    security_opt:
      - no-new-privileges:true       # ç¦æ­¢ææƒ
    
    # ğŸ“ ä¾èµ–å…³ç³»
    depends_on:
      # å¦‚æœéœ€è¦æ•°æ®åº“æˆ–å…¶ä»–æœåŠ¡ï¼Œåœ¨è¿™é‡Œé…ç½®
      # redis:
      #   condition: service_healthy
    
    # ğŸ“‹ æ ‡ç­¾ (ç”¨äºç›‘æ§å’Œç®¡ç†)
    labels:
      - "service.name=onnxocr-modern"
      - "service.version=2.0.0"
      - "service.environment=${ENVIRONMENT:-development}"
      - "monitoring.enabled=true"
      - "backup.enabled=true"